let BASKET={instance:{instanceId:"",totalQuantity:0,totalPrice:0,totalPriceWithoutDiscount:0,percentDiscount:0,discountSum:0,items:[]},init:function(){this.sync()},getItems:function(){return this.instance.items},getTotalQuantity:function(){return this.instance.totalQuantity},getTotalPrice:function(){return this.instance.totalPrice},getDiscountSum:function(){return this.instance.discountSum},getTotalPriceWithoutDiscount:function(){return this.instance.totalPriceWithoutDiscount},getPercentDiscount:function(){return this.instance.percentDiscount},getInstanceId:function(){return this.instance.instanceId},getItem:function(itemId){return this.instance.items[itemId]},getItemQuantity:function(itemId){return this.getItem(itemId).quantity},getItemSubTotal:function(itemId){return this.getItem(itemId).subTotal},add:function(productId,quantity,properties,callback){BASKET.sendRequest({VXBASKET_ADD:"Y",PRODUCT_ID:productId,QUANTITY:parseInt(quantity)||1,PROPERTIES:properties||{}},function(response){if(response.message){BASKET.alert(response.message)}if(response.success){BASKET.sync(response.basket);callback&&typeof callback==="function"?callback(response):null}else if(!response.message){BASKET.alert(BX.message("ERROR_BASKET_UPDATE"))}})},update:function(itemId,quantity,callback){BASKET.sendRequest({VXBASKET_UPDATE:"Y",ITEM_ID:itemId,QUANTITY:parseInt(quantity)||1},function(response){if(response.message){BASKET.alert(response.message)}if(response.success){BASKET.sync(response.basket);callback&&typeof callback==="function"?callback(response):null}else if(!response.message){BASKET.alert(BX.message("ERROR_BASKET_UPDATE"))}})},increment:function(itemId,callback){const qnt=this.getItemQuantity(itemId)+1;this.update(itemId,qnt,callback)},decrement:function(itemId,callback){const qnt=this.getItemQuantity(itemId)-1;if(qnt<1){this.delete(itemId,callback)}else{this.update(itemId,qnt,callback)}},delete:function(itemId,callback){BASKET.sendRequest({ITEM_ID:itemId,VXBASKET_DELETE:"Y"},function(response){if(response.success){BASKET.sync(response.basket);callback&&typeof callback==="function"?callback(response):null}else if(!response.message){BASKET.alert(BX.message("ERROR_BASKET_UPDATE"))}})},reset:function(callback){BASKET.sendRequest({VXBASKET_RESET:"Y"},function(response){if(response.success){BASKET.sync(response.basket);callback&&typeof callback==="function"?callback(response):null}else if(!response.message){BASKET.alert(BX.message("ERROR_BASKET_UPDATE"))}})},sync:function(instance,callback){if(instance){this.instance=instance;this.updateDom();callback&&typeof callback==="function"?callback(response):null}else{BASKET.sendRequest({VXBASKET_FETCH:"Y"},function(response){BASKET.instance=response.basket;BASKET.updateDom();callback&&typeof callback==="function"?callback(response):null})}},updateDom:function(){document.querySelectorAll("[data-basket-total-quantity]").forEach(elem=>elem.textContent=BASKET.formatNum(BASKET.getTotalQuantity(),0,""," "));document.querySelectorAll("[data-basket-total-price]").forEach(elem=>elem.textContent=BASKET.formatNum(BASKET.getTotalPrice(),0,""," "));document.querySelectorAll("[data-basket-total-discount]").forEach(elem=>elem.textContent=BASKET.formatNum(BASKET.getDiscountSum(),0,""," "));document.querySelectorAll("[data-basket-total-price-dirty]").forEach(elem=>elem.textContent=BASKET.formatNum(BASKET.getTotalPriceWithoutDiscount(),0,""," "))},sendRequest:function(data,callback){BX.ajax({url:location.href,data:data,method:"POST",dataType:"json",timeout:30,async:true,scriptsRunFirst:true,emulateOnload:true,start:true,cache:false,onsuccess:function(response){callback&&typeof callback==="function"?callback(response):null},onfailure:function(){console.error(BX.message("ERROR"))}})},alert:function(message,callback){const callbackExist=callback&&typeof callback==="function";let alertPopUp=new BX.PopupWindow("vxPopup_Alert",window.body,{autoHide:!callbackExist,closeByEsc:!callbackExist,titleBar:false,minWidth:320,offsetLeft:0,lightShadow:true,closeIcon:false,padding:15,overlay:{opacity:90},buttons:[new BX.PopupWindowButton({text:"OK",className:"vxBtn",events:{click:function(){this.popupWindow.destroy();if(callbackExist){callback()}}}})]});alertPopUp.setAnimation("fading");alertPopUp.setContent(BX.create("div",{style:{"font-size":"16px",padding:"10px 20px","text-align":"center"},html:message}));alertPopUp.show()},formatNum:function(number,decimals=0,dec_point="",thousands_sep=" "){let n=!isFinite(+number)?0:+number,prec=!isFinite(+decimals)?0:Math.abs(decimals),sep=typeof thousands_sep==="undefined"?",":thousands_sep,dec=typeof dec_point==="undefined"?".":dec_point,toFixedFix=function(n,prec){let k=Math.pow(10,prec);return Math.round(n*k)/k},s=(prec?toFixedFix(n,prec):Math.round(n)).toString().split(".");if(s[0].length>3){s[0]=s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,sep)}if((s[1]||"").length<prec){s[1]=s[1]||"";s[1]+=new Array(prec-s[1].length+1).join("0")}return s.join(dec)}};